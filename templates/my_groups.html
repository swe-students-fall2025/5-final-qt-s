{% extends "base.html" %}
{% block title %}Groups — Roommate Manager{% endblock %}
{% block content %}
  <div class="container">
  <h2>Your groups</h2>

  <div class="card">
    <div id="groupsList" class="grid"></div>
    <div class="space"></div>
    <h4>Create a new group</h4>
    <div class="input-field"><input id="newGroupName" class="input" placeholder="Group name"></div>
    <button class="btn" id="createGroupBtn">Create group</button>
  </div>
{% endblock %}
{% block scripts %}
<script>
async function loadGroups() {
  const userId = sessionStorage.getItem("user_id");
  if (!userId) { showToast("Please login", "error"); window.location.href="/login"; return; }
  
  const container = document.getElementById("groupsList");
  container.innerHTML = `
    <div class="card">
      <div class="shimmer shimmer-title"></div>
      <div class="shimmer shimmer-text"></div>
    </div>
    <div class="card">
      <div class="shimmer shimmer-title"></div>
      <div class="shimmer shimmer-text"></div>
    </div>
  `;
  
  try {
    const groups = await apiGet(`/groups?roommate_id=${userId}`);
    if (!groups || !groups.length) {
      container.innerHTML = "<div class='small text-muted'>No groups found. Create one below.</div>";
      return;
    }
    container.innerHTML = groups.map(g => `
      <div class="card">
        <h4>${g.name}</h4>
        <div class="small text-muted">Created by: ${g.created_by_username || g.created_by || "—"}</div>
        <div class="space"></div>
        <div class="row">
          <button class="btn" onclick="enterGroup('${g.name}')">Enter</button>
          <button class="btn secondary" onclick="openAddRoommateModal('${g._id}', '${g.name}')">Add roommate</button>
        </div>
      </div>
    `).join("");
  } catch (err) {
    container.innerHTML = `<div class='card'><div class='small text-muted'>Error: ${err.message || "Could not load groups"}</div></div>`;
    showToast(err.message || "Could not load groups", "error");
  }
}
function enterGroup(name) {
  const btn = event.target;
  setButtonLoading(btn, true);
  setGroupName(name);
  setTimeout(() => window.location.href = "/home", 300);
}
document.getElementById("createGroupBtn").addEventListener("click", async () => {
  const btn = document.getElementById("createGroupBtn");
  const name = document.getElementById("newGroupName").value.trim();
  const userId = sessionStorage.getItem("user_id");
  if (!name || !userId) return showToast("Group name required", "error");
  
  setButtonLoading(btn, true);
  try {
    await apiPost("/groups", { name, created_by: userId });
    showToast("Group created", "success");
    document.getElementById("newGroupName").value = "";
    loadGroups();
  } catch (err) {
    showToast(err.message || "Create failed", "error");
  } finally {
    setButtonLoading(btn, false);
  }
});
async function openAddRoommateModal(groupId, groupName) {
  const userId = await showPrompt("Add Roommate", `Add a roommate to "${groupName}"`, "User ID or Email");
  if (!userId) return;
  try {
    await apiPost(`/groups/${groupId}/roommates`, { user_id: userId });
    showToast("Roommate added successfully", "success");
    loadGroups();
  } catch (err) {
    showToast(err.message || "Failed to add roommate", "error");
  }
}
loadGroups();
</script>
  </div>
{% endblock %}
