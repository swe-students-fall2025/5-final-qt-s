{% extends "base.html" %}
{% block title %}Groups — Roommate Manager{% endblock %}
{% block content %}
  <div class="container">
  <h2>Your groups</h2>

  <div class="card">
    <div id="groupsList" class="grid"></div>
    <div class="space"></div>
    <h4>Pending Invitations</h4>
    <div id="invitationsList"></div>
    <div class="space"></div>
    <h4>Create a new group</h4>
    <div class="input-field"><input id="newGroupName" class="input" placeholder="Group name"></div>
    <button class="btn" id="createGroupBtn">Create group</button>
  </div>
{% endblock %}
{% block scripts %}
<script>
async function loadGroups() {
  const userId = sessionStorage.getItem("user_id");
  if (!userId) { showToast("Please login", "error"); window.location.href="/login"; return; }
  
  const container = document.getElementById("groupsList");
  container.innerHTML = `
    <div class="card">
      <div class="shimmer shimmer-title"></div>
      <div class="shimmer shimmer-text"></div>
    </div>
    <div class="card">
      <div class="shimmer shimmer-title"></div>
      <div class="shimmer shimmer-text"></div>
    </div>
  `;
  
  try {
    const groups = await apiGet(`/groups?roommate_id=${userId}`);
    if (!groups || !groups.length) {
      container.innerHTML = "<div class='small text-muted'>No groups found. Create one below.</div>";
      return;
    }
    const currentUserId = sessionStorage.getItem("user_id");
    container.innerHTML = groups.map(g => {
      const isCreator = g.created_by === currentUserId;
      const roommatesList = g.roommates_info ? g.roommates_info.map(r => r.username).join(", ") : "None";
      return `
      <div class="card">
        <h4>${g.name}</h4>
        <div class="small text-muted">Created by: ${g.created_by_username || g.created_by || "—"}</div>
        <div class="small text-muted"><strong>Members:</strong> ${roommatesList || "None"}</div>
        <div class="small text-muted">Total: ${g.roommates ? g.roommates.length : 0} member(s)</div>
        <div class="space"></div>
        <div class="row">
          <button class="btn" onclick="enterGroup('${g.name}')">Enter</button>
          <button class="btn secondary" onclick="openAddRoommateModal('${g._id}', '${g.name}')">Invite roommate</button>
          ${isCreator ? `<button class="btn secondary" onclick="deleteGroup('${g._id}', '${g.name}')" style="margin-left: 8px;">Delete</button>` : ''}
        </div>
      </div>
    `;
    }).join("");
  } catch (err) {
    container.innerHTML = `<div class='card'><div class='small text-muted'>Error: ${err.message || "Could not load groups"}</div></div>`;
    showToast(err.message || "Could not load groups", "error");
  }
}
function enterGroup(name) {
  const btn = event.target;
  setButtonLoading(btn, true);
  setGroupName(name);
  setTimeout(() => window.location.href = "/home", 300);
}
document.getElementById("createGroupBtn").addEventListener("click", async () => {
  const btn = document.getElementById("createGroupBtn");
  const name = document.getElementById("newGroupName").value.trim();
  const userId = sessionStorage.getItem("user_id");
  if (!name || !userId) return showToast("Group name required", "error");
  
  setButtonLoading(btn, true);
  try {
    await apiPost("/groups", { name, created_by: userId });
    showToast("Group created", "success");
    document.getElementById("newGroupName").value = "";
    loadGroups();
  } catch (err) {
    showToast(err.message || "Create failed", "error");
  } finally {
    setButtonLoading(btn, false);
  }
});
async function openAddRoommateModal(groupId, groupName) {
  const userInput = await showPrompt("Invite Roommate", `Send an invitation to join "${groupName}"`, "Enter User ID, Email, or Username");
  if (!userInput) return;
  try {
    const userId = sessionStorage.getItem("user_id");
    await apiPost(`/groups/${groupId}/roommates`, { user_id: userInput.trim(), inviter_id: userId });
    showToast("Invitation sent successfully", "success");
    loadGroups();
  } catch (err) {
    showToast(err.message || "Failed to send invitation", "error");
  }
}

async function deleteGroup(groupId, groupName) {
  const confirmed = confirm(`Are you sure you want to delete "${groupName}"? This action cannot be undone.`);
  if (!confirmed) return;
  
  const userId = sessionStorage.getItem("user_id");
  if (!userId) {
    showToast("Please login to delete groups", "error");
    return;
  }
  
  try {
    // Use apiFetch to send DELETE with body
    await apiFetch(`/groups/${groupId}`, {
      method: "DELETE",
      body: JSON.stringify({ creator_id: userId })
    });
    showToast("Group deleted successfully", "success");
    loadGroups();
  } catch (err) {
    showToast(err.message || "Failed to delete group", "error");
  }
}

async function loadInvitations() {
  const userId = sessionStorage.getItem("user_id");
  if (!userId) return;
  
  const container = document.getElementById("invitationsList");
  try {
    const invitations = await apiGet(`/invitations?user_id=${userId}`);
    if (!invitations || !invitations.length) {
      container.innerHTML = "<div class='small text-muted'>No pending invitations</div>";
      return;
    }
    
    container.innerHTML = invitations.map(inv => `
      <div class="card" style="margin-bottom: 8px;">
        <div><strong>${inv.group?.name || inv.group_name || "Group"}</strong></div>
        <div class="small text-muted">
          ${inv.inviter_username ? `Invited by: ${inv.inviter_username}` : 'You have been invited'}
        </div>
        <div class="row" style="margin-top: 8px;">
          <button class="btn" onclick="acceptInvitation('${inv.group_id}', '${inv.invited_user_id}')">Accept</button>
          <button class="btn secondary" onclick="declineInvitation('${inv.group_id}', '${inv.invited_user_id}')" style="margin-left: 8px;">Decline</button>
        </div>
      </div>
    `).join("");
  } catch (err) {
    container.innerHTML = `<div class='small text-muted'>Error loading invitations: ${err.message}</div>`;
  }
}

async function acceptInvitation(groupId, userId) {
  try {
    await apiPost(`/groups/${groupId}/roommates/${userId}/accept`, {});
    showToast("Invitation accepted! You've been added to the group.", "success");
    loadGroups();
    loadInvitations();
  } catch (err) {
    showToast(err.message || "Failed to accept invitation", "error");
  }
}

async function declineInvitation(groupId, userId) {
  try {
    await apiPost(`/groups/${groupId}/roommates/${userId}/decline`, {});
    showToast("Invitation declined", "success");
    loadInvitations();
  } catch (err) {
    showToast(err.message || "Failed to decline invitation", "error");
  }
}

loadGroups();
loadInvitations();
</script>
  </div>
{% endblock %}
