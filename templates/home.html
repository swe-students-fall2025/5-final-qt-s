{% extends "base.html" %}
{% block title %}Dashboard — Roommate Manager{% endblock %}
{% block head %}
  <style>
    #billCard:hover, #choreCard:hover, #eventCard:hover, #groupCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="container">
  <h2>Dashboard</h2>

  <!-- Group Selection Section -->
  <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="row" style="align-items: center;">
      <div style="flex: 1;">
        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 4px;">Current Group</div>
        <div style="font-size: 1.25rem; font-weight: 600;" id="groupNameDisplay">Select a group</div>
      </div>
      <button class="btn" onclick="window.location.href='/my_groups'" style="background: white; color: #667eea; border: none;">
        Change Group
      </button>
    </div>
  </div>

  <div id="no-group" class="card" style="display:none;">
    <div class="small">No group selected. Go to <a href="/my_groups">My Groups</a> and choose a group.</div>
  </div>

  <div id="main-grid" class="grid" style="display:none;">
    <div class="card" style="cursor: pointer;" onclick="window.location.href='/bills'" id="billCard">
      <h4>Bill Status</h4>
      <div id="billBox">
        <div class="shimmer shimmer-title"></div>
        <div class="shimmer shimmer-text"></div>
      </div>
    </div>

    <div class="card" style="cursor: pointer;" onclick="window.location.href='/chores'" id="choreCard">
      <h4>Chore Status</h4>
      <div id="choreBox">
        <div class="shimmer shimmer-title"></div>
        <div class="shimmer shimmer-text"></div>
      </div>
    </div>

    <div class="card" style="cursor: pointer;" onclick="window.location.href='/calendar'" id="eventCard">
      <h4>Event Status</h4>
      <div id="eventBox">
        <div class="shimmer shimmer-title"></div>
        <div class="shimmer shimmer-text"></div>
      </div>
    </div>

    <div class="card" style="cursor: pointer;" onclick="window.location.href='/my_groups'" id="groupCard">
      <h4>Groups</h4>
      <div id="groupBox">
        <div class="shimmer shimmer-title"></div>
        <div class="shimmer shimmer-text"></div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>
const groupName = getGroupName();
if (!groupName) {
  document.getElementById("no-group").style.display = "block";
} else {
  document.getElementById("main-grid").style.display = "grid";
  async function loadAll() {
    try {
      // Load all data in parallel for faster loading
      const userId = sessionStorage.getItem("user_id");
      const [bills, chores, calendar, groups] = await Promise.all([
        apiGet(`/api/groups/${groupName}/bills`).catch(() => ({ error: null })),
        apiGet(`/groups/${groupName}/chores`).catch(() => ({ chores: [] })),
        apiGet(`/api/groups/${groupName}/calendar`).catch(() => ([])),
        userId ? apiGet(`/groups?roommate_id=${userId}`).catch(() => ([])) : Promise.resolve([])
      ]);

      // Bills Status - Show overdue count and due soon
      const billBox = document.getElementById("billBox");
      if (bills.error) {
        billBox.innerHTML = `<div class="small text-muted">${bills.error}</div>`;
      } else {
        const unpaidBills = bills.bills ? bills.bills.filter(b => !b.paid) : [];
        const overdueCount = bills.overdue_count || 0;
        const dueSoonCount = bills.due_soon_count || 0;
        const totalUnpaid = unpaidBills.length;
        
        let html = '';
        if (totalUnpaid === 0) {
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: #059669;">All bills paid ✅</div>`;
        } else {
          const overdueText = overdueCount > 0 ? `${overdueCount} overdue` : '';
          const dueSoonText = dueSoonCount > 0 ? `${dueSoonCount} due soon` : '';
          const statusText = [overdueText, dueSoonText].filter(Boolean).join(', ') || `${totalUnpaid} pending`;
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: ${overdueCount > 0 ? '#dc2626' : '#2563eb'};">${statusText}</div>`;
        }
        billBox.innerHTML = html;
      }

      // Chore Status - Show overdue count and pending
      const cBox = document.getElementById("choreBox");
      if (!chores || !chores.chores || chores.chores.length === 0) {
        cBox.innerHTML = `<div style="font-size: 1.25rem; font-weight: 600; color: #059669;">All chores done ✅</div>`;
      } else {
        const pendingChores = chores.chores.filter(c => c.status !== 'completed');
        const overdueChores = pendingChores.filter(c => c.status === 'OVERDUE');
        const dueSoonChores = pendingChores.filter(c => {
          if (c.status === 'OVERDUE' || c.status === 'completed') return false;
          if (!c.due_date) return false;
          const dueDate = new Date(c.due_date.split('T')[0] || c.due_date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
          return daysUntil >= 0 && daysUntil <= 7;
        });
        
        const count = pendingChores.length;
        let html = '';
        if (count === 0) {
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: #059669;">All chores done ✅</div>`;
        } else {
          const overdueText = overdueChores.length > 0 ? `${overdueChores.length} overdue` : '';
          const dueSoonText = dueSoonChores.length > 0 ? `${dueSoonChores.length} due this week` : '';
          const statusText = [overdueText, dueSoonText].filter(Boolean).join(', ') || `${count} pending`;
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: ${overdueChores.length > 0 ? '#dc2626' : '#2563eb'};">${statusText}</div>`;
        }
        cBox.innerHTML = html;
      }

      // Event Status - Show upcoming events
      const eventBox = document.getElementById("eventBox");
      if (calendar.error) {
        eventBox.innerHTML = `<div class="small text-muted">${calendar.error}</div>`;
      } else {
        const events = calendar || [];
        const customEvents = events.filter(e => e.type === 'event');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekFromNow = new Date(today);
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        
        const upcomingEvents = customEvents.filter(e => {
          if (!e.start_datetime && !e.start && !e.date) return false;
          const eventDate = e.start_datetime || e.start || e.date;
          const dateStr = eventDate.split('T')[0] || eventDate.split(' ')[0];
          const eventDateObj = new Date(dateStr);
          return eventDateObj >= today && eventDateObj <= weekFromNow;
        });
        
        let html = '';
        if (upcomingEvents.length === 0) {
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: #059669;">All tasks done ✅</div>`;
        } else if (upcomingEvents.length === 1) {
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: #2563eb;">1 event this week</div>`;
        } else {
          html = `<div style="font-size: 1.25rem; font-weight: 600; color: #2563eb;">${upcomingEvents.length} events this week</div>`;
        }
        eventBox.innerHTML = html;
      }

      // Groups Status
      const groupBox = document.getElementById("groupBox");
      const groupList = Array.isArray(groups) ? groups : [];
      const count = groupList.length;
      let html = '';
      if (count === 0) {
        html = `<div style="font-size: 1.25rem; font-weight: 600; color: #475569;">No groups</div>`;
      } else if (count === 1) {
        html = `<div style="font-size: 1.25rem; font-weight: 600; color: #2563eb;">1 group</div>`;
      } else {
        html = `<div style="font-size: 1.25rem; font-weight: 600; color: #2563eb;">${count} groups</div>`;
      }
      groupBox.innerHTML = html;

    } catch (err) {
      console.error('Dashboard load error:', err);
      showToast(err.message || "Could not load dashboard", "error");
    }
  }
  loadAll();
}
</script>
  </div>
{% endblock %}
