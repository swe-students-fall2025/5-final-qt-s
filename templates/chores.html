{% extends "base.html" %}
{% block title %}Chores ‚Äî Roommate Manager{% endblock %}
{% block content %}
  <div class="container">
  <h2>Chore Board</h2>

  <div class="card" style="margin-bottom:12px;">
    <div class="row">
      <button class="btn" onclick="openAddChoreModal()">Add chore</button>
      <div class="right small text-muted">Group: <span id="groupNameDisplay"></span></div>
    </div>
  </div>

  <div id="choresList"></div>

  <!-- Add Chore Modal -->
  <div id="modal-add-chore-backdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Add Chore</h3>
      <div class="input-field">
        <label>Task</label>
        <input id="add_task" class="input" placeholder="Enter task name">
      </div>
      <div class="input-field">
        <label>Assigned To</label>
        <input id="add_assigned" class="input" placeholder="Roommate name">
      </div>
      <div class="input-field">
        <label>Due Date</label>
        <input type="date" id="add_due" class="input">
      </div>
      <div class="input-field">
        <label>Recurring?</label>
        <select id="add_recurring" class="input">
          <option value="">Not recurring</option>
          <option value="daily">Every day</option>
          <option value="weekly">Every week</option>
          <option value="biweekly">Every 2 weeks</option>
          <option value="monthly">Every month</option>
        </select>
      </div>
      <div class="input-field">
        <label>Photo / Video of Chore (optional)</label>
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <button type="button" class="btn secondary" onclick="openCameraView()" style="flex: 1; min-width: 120px;">
            üì∑ Take Photo/Video
          </button>
          <button type="button" class="btn secondary" onclick="document.getElementById('add_media_file').click()" style="flex: 1; min-width: 120px;">
            üìÅ Choose File
          </button>
        </div>
        <input id="add_media_file" type="file" accept="image/*,video/*" style="display: none;" />
        
        <!-- Live Camera View -->
        <div id="camera_view_container" style="display: none; margin-top: 12px;">
          <video id="camera_preview" autoplay playsinline style="width: 100%; max-height: 300px; border-radius: 4px; background: #000;"></video>
          <canvas id="camera_canvas" style="display: none;"></canvas>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button type="button" class="btn" onclick="capturePhoto()" style="flex: 1;">üì∏ Take Photo</button>
            <button type="button" class="btn" id="record_video_btn" onclick="startVideoRecording()" style="flex: 1;">üé• Record Video</button>
            <button type="button" class="btn secondary" onclick="closeCameraView()" style="flex: 1;">Cancel</button>
          </div>
          <div id="video_recording_controls" style="display: none; margin-top: 8px;">
            <button type="button" class="btn" id="stop_recording_btn" onclick="stopVideoRecording()" style="width: 100%;">‚èπ Stop Recording</button>
          </div>
        </div>
        
        <!-- Preview of captured/selected media -->
        <div id="add_media_preview" style="margin-top: 8px; display: none;">
          <img id="add_media_preview_img" style="max-width: 100%; max-height: 200px; border-radius: 4px;" />
          <video id="add_media_preview_video" style="max-width: 100%; max-height: 200px; border-radius: 4px; display: none;" controls></video>
          <button type="button" class="btn secondary" onclick="clearMediaPreview()" style="margin-top: 8px; width: 100%;">Remove</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal('modal-add-chore')">Cancel</button>
        <button class="btn" id="modal-add-chore-save-btn" onclick="submitAddChore()">Save</button>
      </div>

    </div>
  </div>

  <!-- Confirm Complete Modal -->
  <div id="modal-confirm-complete-backdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Confirm completion</h3>
      <div id="confirmText" class="small text-muted">Are you sure?</div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal('modal-confirm-complete')">Cancel</button>
        <button class="btn" id="confirmCompleteBtn">Yes, mark complete</button>
      </div>
    </div>
  </div>

  <!-- Edit Chore Modal -->
  <div id="modal-edit-chore-backdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Edit Chore</h3>
      <div class="input-field"><label class="small">Task</label><input id="edit_task" class="input"></div>
      <div class="input-field"><label class="small">Assigned To</label><input id="edit_assigned" class="input"></div>
      <div class="input-field"><label class="small">Due</label><input id="edit_due" class="input"></div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal('modal-edit-chore')">Cancel</button>
        <button class="btn" onclick="submitEditChore()">Save</button>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById("groupNameDisplay").innerText = getGroupName() || "(no group)";

let choresCache = [];
async function loadChores() {
  const groupName = getGroupName();
  const container = document.getElementById("choresList");
  if (!groupName) { 
    container.innerHTML = "<div class='card small'>Select a group first (My Groups)</div>"; 
    return; 
  }
  
  container.innerHTML = `
    <div class="chore-row">
      <div class="shimmer shimmer-title" style="width: 200px;"></div>
      <div class="shimmer shimmer-button"></div>
    </div>
    <div class="chore-row">
      <div class="shimmer shimmer-title" style="width: 200px;"></div>
      <div class="shimmer shimmer-button"></div>
    </div>
  `;
  
  try {
    const data = await apiGet(`/groups/${groupName}/chores`);
    choresCache = data.chores || [];
    renderChores();
  } catch (err) {
    container.innerHTML = `<div class='card small'>Error: ${err.message || "Could not load chores"}</div>`;
    showToast(err.message || "Could not load chores", "error");
  }
}

function renderChores() {
  const container = document.getElementById("choresList");
  if (!choresCache.length) {
    container.innerHTML = "<div class='card small text-muted'>No chores</div>";
    return;
  }
  container.innerHTML = choresCache.map(c => {
    const isCompleted = c.status === 'completed';
    const mediaHtml = c.media_url ? 
      (c.media_url.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? 
        `<img src="${c.media_url}" style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-top: 8px; display: block;" alt="Chore media" />` :
        `<video src="${c.media_url}" style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-top: 8px; display: block;" controls></video>`
      ) : '';
    return `
    <div class="chore-row">
      <div>
        <div><b>${c.task}</b></div>
        <div class="small text-muted">Assigned: ${c.assigned_to} ‚Ä¢ Due: ${c.due_date}</div>
        ${mediaHtml}
      </div>
      <div class="row">
        <span class="${c.status === 'OVERDUE' ? 'overdue' : c.status === 'completed' ? 'ok' : 'warn'}">${c.status}</span>
        ${!isCompleted ? `<button class="btn secondary" style="margin-left:8px;" onclick="openEditChore('${c.id}')">Edit</button>` : ''}
        ${!isCompleted ? `<button class="btn" style="margin-left:8px;" onclick="confirmComplete('${c.id}')">Complete</button>` : ''}
      </div>
    </div>
    `;
  }).join("");
}

function openAddChoreModal() {
  setModalField('modal-add-chore', '#add_task', '');
  setModalField('modal-add-chore', '#add_assigned', '');
  setModalField('modal-add-chore', '#add_due', '');
  document.getElementById('add_recurring').value = '';
  clearMediaPreview();
  closeCameraView(); // Make sure camera is closed
  capturedMediaFile = null;
  // Reset button state when opening modal
  const btn = document.getElementById('modal-add-chore-save-btn');
  if (btn) setButtonLoading(btn, false);
  openModal('modal-add-chore');
}

// Camera and media handling
let cameraStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let capturedMediaFile = null;

function openCameraView() {
  const container = document.getElementById('camera_view_container');
  const preview = document.getElementById('camera_preview');
  
  container.style.display = 'block';
  document.getElementById('add_media_preview').style.display = 'none';
  
  // Request camera access
  navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: 'environment' }, 
    audio: true 
  })
  .then(stream => {
    cameraStream = stream;
    preview.srcObject = stream;
  })
  .catch(err => {
    showToast("Could not access camera: " + err.message, "error");
    closeCameraView();
  });
}

function closeCameraView() {
  const container = document.getElementById('camera_view_container');
  const preview = document.getElementById('camera_preview');
  const recordingControls = document.getElementById('video_recording_controls');
  
  // Stop camera stream
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  
  // Stop recording if active
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  
  preview.srcObject = null;
  container.style.display = 'none';
  recordingControls.style.display = 'none';
  document.getElementById('record_video_btn').style.display = 'block';
}

function capturePhoto() {
  const preview = document.getElementById('camera_preview');
  const canvas = document.getElementById('camera_canvas');
  const previewImg = document.getElementById('add_media_preview_img');
  const previewDiv = document.getElementById('add_media_preview');
  
  canvas.width = preview.videoWidth;
  canvas.height = preview.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(preview, 0, 0);
  
  // Convert canvas to blob
  canvas.toBlob(function(blob) {
    capturedMediaFile = new File([blob], 'photo_' + Date.now() + '.jpg', { type: 'image/jpeg' });
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      document.getElementById('add_media_preview_video').style.display = 'none';
      previewImg.style.display = 'block';
      previewDiv.style.display = 'block';
    };
    reader.readAsDataURL(blob);
    
    closeCameraView();
    showToast("Photo captured!", "success");
  }, 'image/jpeg', 0.9);
}

function startVideoRecording() {
  const preview = document.getElementById('camera_preview');
  const recordingControls = document.getElementById('video_recording_controls');
  
  recordedChunks = [];
  
  try {
    mediaRecorder = new MediaRecorder(cameraStream, {
      mimeType: 'video/webm;codecs=vp8,opus'
    });
    
    mediaRecorder.ondataavailable = function(event) {
      if (event.data.size > 0) {
        recordedChunks.push(event.data);
      }
    };
    
    mediaRecorder.onstop = function() {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      capturedMediaFile = new File([blob], 'video_' + Date.now() + '.webm', { type: 'video/webm' });
      
      // Show preview
      const previewVideo = document.getElementById('add_media_preview_video');
      const previewImg = document.getElementById('add_media_preview_img');
      const previewDiv = document.getElementById('add_media_preview');
      
      previewVideo.src = URL.createObjectURL(blob);
      previewImg.style.display = 'none';
      previewVideo.style.display = 'block';
      previewDiv.style.display = 'block';
      
      closeCameraView();
      showToast("Video recorded!", "success");
    };
    
    mediaRecorder.start();
    document.getElementById('record_video_btn').style.display = 'none';
    recordingControls.style.display = 'block';
  } catch (err) {
    showToast("Could not start recording: " + err.message, "error");
  }
}

function stopVideoRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
}

function clearMediaPreview() {
  document.getElementById('add_media_file').value = '';
  document.getElementById('add_media_preview').style.display = 'none';
  document.getElementById('add_media_preview_img').src = '';
  const videoEl = document.getElementById('add_media_preview_video');
  if (videoEl.src) {
    URL.revokeObjectURL(videoEl.src);
    videoEl.src = '';
  }
  capturedMediaFile = null;
}

// Preview media when file is selected (from camera or file picker)
function handleMediaSelection(file) {
  if (!file) {
    document.getElementById('add_media_preview').style.display = 'none';
    return;
  }
  
  const preview = document.getElementById('add_media_preview');
  const previewImg = document.getElementById('add_media_preview_img');
  const previewVideo = document.getElementById('add_media_preview_video');
  
  preview.style.display = 'block';
  
  if (file.type.startsWith('image/')) {
    previewImg.style.display = 'block';
    previewVideo.style.display = 'none';
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else if (file.type.startsWith('video/')) {
    previewImg.style.display = 'none';
    previewVideo.style.display = 'block';
    // Revoke old URL if exists
    if (previewVideo.src) {
      URL.revokeObjectURL(previewVideo.src);
    }
    previewVideo.src = URL.createObjectURL(file);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('add_media_file');
  
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        capturedMediaFile = null; // Clear captured file if selecting from picker
        handleMediaSelection(file);
      }
    });
  }
});

async function submitAddChore() {
  const task = document.getElementById('add_task').value.trim();
  const assigned = document.getElementById('add_assigned').value.trim();
  const due = document.getElementById('add_due').value;
  const recurring = document.getElementById('add_recurring').value;
  // Get file from captured media or file input
  const fileFile = document.getElementById('add_media_file').files[0];
  const mediaFile = capturedMediaFile || fileFile;

  
  if (!task || !due) return showToast("Task and due date required", "error");
  
  const groupName = getGroupName();
  const btn = document.getElementById('modal-add-chore-save-btn');
  if (!btn) return;

  // Map recurring option to frequency_days
  const frequencyMap = {
    "daily": 1,
    "weekly": 7,
    "biweekly": 14,
    "monthly": 30,
    "": 0
  };
  
  const is_recurring = recurring !== "";
  const frequency_days = frequencyMap[recurring] || 0;
  
  setButtonLoading(btn, true);
  try {
    // Use FormData if there's a media file, otherwise use JSON
    if (mediaFile) {
      const formData = new FormData();
      formData.append('task', task);
      formData.append('assigned_to', assigned);
      formData.append('due_date', due);
      formData.append('is_recurring', is_recurring);
      formData.append('frequency_days', frequency_days);
      formData.append('media', mediaFile);
      
      await apiPostFormData(`/groups/${groupName}/chores`, formData);
    } else {
      await apiPost(`/groups/${groupName}/chores`, { 
        task, 
        assigned_to: assigned, 
        due_date: due, 
        is_recurring,
        frequency_days
      });
    }
    setButtonLoading(btn, false); // Reset button state BEFORE closing modal
    closeModal('modal-add-chore');
    showToast("Chore added", "success");
    loadChores();
  } catch (err) {
    showToast(err.message || "Add failed", "error");
    setButtonLoading(btn, false);
  }
}

/* Confirm flow */
let pendingCompleteId = null;
function confirmComplete(id) {
  pendingCompleteId = id;
  document.getElementById("confirmText").innerText = "Mark this chore as complete?";
  const btn = document.getElementById("confirmCompleteBtn");
  btn.onclick = async () => {
    try {
      const res = await apiPost(`/chores/${pendingCompleteId}/complete`, {});
      closeModal('modal-confirm-complete');
      showToast(res.message || "Completed", "success");
      loadChores();
    } catch (err) {
      showToast(err.message || "Complete failed", "error");
    }
  };
  openModal('modal-confirm-complete');
}

/* Edit flow */
let editingId = null;
function openEditChore(id) {
  const c = choresCache.find(x => x.id === id);
  if (!c) return;
  editingId = id;
  setModalField('modal-edit-chore', '#edit_task', c.task);
  setModalField('modal-edit-chore', '#edit_assigned', c.assigned_to);
  setModalField('modal-edit-chore', '#edit_due', c.due_date);
  openModal('modal-edit-chore');
}

async function submitEditChore() {
  const task = document.getElementById('edit_task').value.trim();
  const assigned = document.getElementById('edit_assigned').value.trim();
  const due = document.getElementById('edit_due').value.trim();
  if (!task || !due) return showToast("Task and due date required", "error");
  try {
    await apiPatch(`/chores/${editingId}`, { task, assigned_to: assigned, due_date: due });
    closeModal('modal-edit-chore');
    showToast("Updated", "success");
    loadChores();
  } catch (err) {
    showToast(err.message || "Update failed", "error");
  }
}

loadChores();
</script>
  </div>
{% endblock %}
