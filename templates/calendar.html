{% extends "base.html" %}
{% block title %}Calendar ‚Äî Roommate Manager{% endblock %}
{% block head %}
  <style>
    .calendar-container {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }
    
    .calendar-sidebar {
      width: 280px;
      flex-shrink: 0;
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .calendar-main {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .create-button {
      width: 100%;
      padding: 12px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 24px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .create-button:hover {
      background: #1765cc;
    }
    
    .group-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .group-display .label {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .group-display .name {
      font-size: 1rem;
      font-weight: 500;
    }
    
    /* Simple Calendar Styles */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .calendar-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: #5f6368;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .calendar-day {
      min-height: 100px;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .calendar-day:hover {
      background: #f8f9fa;
      border-color: #667eea;
    }
    
    .calendar-day.today {
      background: #fff7ed;
      border-color: #f59e0b;
      font-weight: 600;
    }
    
    .calendar-day.other-month {
      background: #f8f9fa;
      color: #9ca3af;
    }
    
    .day-number {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.875rem;
    }
    
    .day-event {
      font-size: 0.75rem;
      padding: 2px 4px;
      margin-bottom: 2px;
      border-radius: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }
    
    .day-event.bill {
      background: #ffebee;
      color: #c62828;
    }
    
    .day-event.chore {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .day-event.shopping {
      background: #fff9c4;
      color: #f57f17;
    }
    
    .day-event.event {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .day-events-panel {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
    
    .day-events-panel h4 {
      margin-top: 0;
      margin-bottom: 16px;
    }
    
    .event-card {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 4px solid;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .event-card:hover {
      transform: translateX(4px);
    }
    
    .event-card.bill {
      background: #ffebee;
      border-left-color: #f44336;
    }
    
    .event-card.chore {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    
    .event-card.shopping {
      background: #fff9c4;
      border-left-color: #ffc107;
    }
    
    .event-card.event {
      background: #e3f2fd;
      border-left-color: #2196f3;
    }
    
    .event-card-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .event-card-details {
      font-size: 0.875rem;
      color: #666;
    }
    
    .sticky-notes-container {
      margin-top: 24px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .sticky-notes-container h4 {
      font-size: 0.875rem;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .sticky-note {
      background: #fff9c4;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #fbc02d;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .sticky-note:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .sticky-note.bill {
      background: #ffebee;
      border-left-color: #f44336;
    }
    
    .sticky-note.chore {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    
    .sticky-note.shopping {
      background: #fff9c4;
      border-left-color: #ffc107;
    }
    
    .sticky-note.event {
      background: #e3f2fd;
      border-left-color: #2196f3;
    }
    
    .sticky-note-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    
    .sticky-note-date {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 4px;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="container">
  <h2>Calendar</h2>

  <div class="calendar-container">
    <!-- Left Sidebar -->
    <div class="calendar-sidebar">
      <button class="create-button" onclick="openAddEventModal()">
        <span style="font-size: 1.2rem;">+</span>
        <span>Create</span>
      </button>
      
      <div class="group-display">
        <div class="label">Current Group</div>
        <div class="name" id="groupNameDisplay">Select a group</div>
        <button class="btn" onclick="window.location.href='/my_groups'" style="background: white; color: #667eea; border: none; margin-top: 8px; width: 100%; padding: 8px;">
          Change Group
        </button>
      </div>
      
      <!-- Sticky Notes Section -->
      <div class="sticky-notes-container">
        <h4>Upcoming Events</h4>
        <div id="stickyNotesList">
          <div class="small text-muted">Loading events...</div>
        </div>
      </div>
    </div>

    <!-- Main Calendar -->
    <div class="calendar-main">
      <!-- Simple Month View -->
      <div id="simpleCalendar">
        <div class="calendar-header">
          <button class="btn secondary" onclick="changeMonth(-1)">‚Üê Prev</button>
          <h3 id="currentMonthYear"></h3>
          <button class="btn secondary" onclick="changeMonth(1)">Next ‚Üí</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <div id="dayEvents" class="day-events-panel" style="display: none;">
          <h4 id="selectedDateTitle"></h4>
          <div id="dayEventsList"></div>
          <button class="btn secondary" onclick="closeDayEvents()" style="margin-top: 12px;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="modal-add-event-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 600px;">
      <h3>Create Event</h3>
      <div class="input-field">
        <label>Event Title</label>
        <input id="add_event_title" class="input" placeholder="Add title">
      </div>
      <div class="input-field">
        <label>Description (optional)</label>
        <textarea id="add_event_description" class="input" rows="3" placeholder="Add description"></textarea>
      </div>
      <div class="input-field">
        <label>
          <input type="checkbox" id="add_event_all_day" style="margin-right: 8px;" onchange="toggleAllDay('add')">
          All day
        </label>
      </div>
      <div id="add_event_time_fields">
        <div class="input-field">
          <label>Start</label>
          <input type="datetime-local" id="add_event_start" class="input">
        </div>
        <div class="input-field">
          <label>End</label>
          <input type="datetime-local" id="add_event_end" class="input">
        </div>
      </div>
      <div id="add_event_date_fields" style="display: none;">
        <div class="input-field">
          <label>Start date</label>
          <input type="date" id="add_event_start_date" class="input">
        </div>
        <div class="input-field">
          <label>End date</label>
          <input type="date" id="add_event_end_date" class="input">
        </div>
      </div>
      <div class="input-field">
        <label>Who can see this event?</label>
        <select id="add_event_visibility" class="input" onchange="updateEventVisibilityCheckboxes('add')">
          <option value="only_me">Only me</option>
          <option value="all">All team</option>
        </select>
      </div>
      <div class="input-field">
        <label>Select members who can see this event</label>
        <div id="add_event_members_list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 8px;">
          <div class="small text-muted">Loading members...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal('modal-add-event')">Cancel</button>
        <button class="btn" onclick="submitAddEvent()">Create</button>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div id="modal-edit-event-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 600px;">
      <h3>Edit Event</h3>
      <div class="input-field">
        <label>Event Title</label>
        <input id="edit_event_title" class="input">
      </div>
      <div class="input-field">
        <label>Description (optional)</label>
        <textarea id="edit_event_description" class="input" rows="3"></textarea>
      </div>
      <div class="input-field">
        <label>
          <input type="checkbox" id="edit_event_all_day" style="margin-right: 8px;" onchange="toggleAllDay('edit')">
          All day
        </label>
      </div>
      <div id="edit_event_time_fields">
        <div class="input-field">
          <label>Start</label>
          <input type="datetime-local" id="edit_event_start" class="input">
        </div>
        <div class="input-field">
          <label>End</label>
          <input type="datetime-local" id="edit_event_end" class="input">
        </div>
      </div>
      <div id="edit_event_date_fields" style="display: none;">
        <div class="input-field">
          <label>Start date</label>
          <input type="date" id="edit_event_start_date" class="input">
        </div>
        <div class="input-field">
          <label>End date</label>
          <input type="date" id="edit_event_end_date" class="input">
        </div>
      </div>
      <div class="input-field">
        <label>Who can see this event?</label>
        <select id="edit_event_visibility" class="input" onchange="updateEventVisibilityCheckboxes('edit')">
          <option value="only_me">Only me</option>
          <option value="all">All team</option>
        </select>
      </div>
      <div class="input-field">
        <label>Select members who can see this event</label>
        <div id="edit_event_members_list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 8px;">
          <div class="small text-muted">Loading members...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal('modal-edit-event')">Cancel</button>
        <button class="btn" onclick="submitEditEvent()">Save</button>
        <button class="btn" style="background: var(--error);" onclick="confirmDeleteEvent()">Delete</button>
      </div>
    </div>
  </div>

{% endblock %}
{% block scripts %}
  <script>
    let currentDate = new Date();
    let allEvents = [];
    let editingEventId = null;
    let selectedDate = null;

    // Ensure group name is set on page load
    const currentGroupName = getGroupName();
    if (!currentGroupName || currentGroupName === "null" || currentGroupName === "undefined") {
      if (window.location.pathname === "/calendar") {
        showToast("Please select a group first", "error");
        setTimeout(() => window.location.href = "/my_groups", 2000);
      }
    }
    const groupNameDisplayEl = document.getElementById("groupNameDisplay");
    if (groupNameDisplayEl) {
      groupNameDisplayEl.innerText = currentGroupName || "(no group)";
    }

    // Simple Calendar Functions
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      // Day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
      });
      
      // Empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        grid.appendChild(emptyDay);
      }
      
      // Days of the month
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        if (dayDate.getTime() === today.getTime()) {
          dayElement.classList.add('today');
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // Add events for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = getEventsForDate(dateStr);
        
        dayEvents.forEach(ev => {
          const eventEl = document.createElement('div');
          eventEl.className = `day-event ${ev.type}`;
          eventEl.textContent = ev.title;
          eventEl.title = ev.title;
          eventEl.onclick = (e) => {
            e.stopPropagation();
            showDayEvents(dateStr, dayEvents);
          };
          dayElement.appendChild(eventEl);
        });
        
        dayElement.onclick = () => {
          if (dayEvents.length > 0) {
            showDayEvents(dateStr, dayEvents);
          } else {
            openAddEventModal(dateStr);
          }
        };
        
        grid.appendChild(dayElement);
      }
      
      // Empty cells for days after month ends
      const totalCells = startingDayOfWeek + daysInMonth;
      const remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day other-month';
          grid.appendChild(emptyDay);
        }
      }
    }
    
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      renderCalendar();
      loadEvents();
    }
    
    function getEventsForDate(dateStr) {
      return allEvents.filter(ev => {
        const eventDate = ev.start_datetime || ev.start || ev.date;
        if (!eventDate) return false;
        const evDateStr = eventDate.split('T')[0] || eventDate.split(' ')[0];
        return evDateStr === dateStr;
      });
    }
    
    function showDayEvents(dateStr, events) {
      selectedDate = dateStr;
      const panel = document.getElementById('dayEvents');
      const title = document.getElementById('selectedDateTitle');
      const list = document.getElementById('dayEventsList');
      
      const date = new Date(dateStr);
      const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      title.textContent = dateFormatted;
      
      list.innerHTML = events.map(ev => {
        const type = ev.type || 'event';
        let details = '';
        if (type === 'bill' && ev.amount) {
          details = `Amount: $${ev.amount}`;
        } else if (type === 'chore' && ev.assignee) {
          details = `Assigned to: ${ev.assignee}`;
        } else if (type === 'event' && ev.description) {
          details = ev.description;
        }
        
        return `
          <div class="event-card ${type}" onclick="handleEventClick('${ev.id || ev._id}', '${type}')">
            <div class="event-card-title">${ev.title}</div>
            ${details ? `<div class="event-card-details">${details}</div>` : ''}
          </div>
        `;
      }).join('');
      
      panel.style.display = 'block';
    }
    
    function closeDayEvents() {
      document.getElementById('dayEvents').style.display = 'none';
      selectedDate = null;
    }
    
    function handleEventClick(eventId, type) {
      if (type === 'event') {
        openEditEventModal(eventId);
      } else {
        if (type === 'bill') {
          window.location.href = '/bills';
        } else if (type === 'chore') {
          window.location.href = '/chores';
        }
      }
    }
    
    async function loadEvents() {
      const groupName = getGroupName();
      if (!groupName || groupName === "null" || groupName === "undefined") {
        return;
      }
      
      try {
        const raw = await apiGet(`/groups/${groupName}/calendar`);
        allEvents = raw || [];
        updateStickyNotes(allEvents);
        renderCalendar();
      } catch (err) {
        console.error("Error loading events:", err);
        showToast("Failed to load events", "error");
      }
    }
    
    function updateStickyNotes(events) {
      const container = document.getElementById('stickyNotesList');
      if (!container) return;
      
      if (!events || events.length === 0) {
        container.innerHTML = '<div class="small text-muted">No upcoming events</div>';
        return;
      }
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const thirtyDaysFromNow = new Date(today);
      thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
      
      const upcomingEvents = events.filter(ev => {
        const eventDate = ev.start_datetime || ev.start || ev.date;
        if (!eventDate) return false;
        const dateStr = eventDate.split('T')[0] || eventDate.split(' ')[0];
        const eventDateObj = new Date(dateStr);
        return eventDateObj >= today && eventDateObj <= thirtyDaysFromNow;
      }).sort((a, b) => {
        const dateA = new Date(a.start_datetime || a.start || a.date);
        const dateB = new Date(b.start_datetime || b.start || b.date);
        return dateA - dateB;
      });
      
      if (upcomingEvents.length === 0) {
        container.innerHTML = '<div class="small text-muted">No upcoming events in the next 30 days</div>';
        return;
      }
      
      container.innerHTML = upcomingEvents.slice(0, 10).map(ev => {
        const type = ev.type || 'event';
        const title = ev.title || 'Untitled';
        const eventDate = ev.start_datetime || ev.start || ev.date;
        const dateStr = eventDate ? (eventDate.split('T')[0] || eventDate.split(' ')[0]) : '';
        const dateObj = dateStr ? new Date(dateStr) : null;
        
        let dateDisplay = dateStr;
        if (dateObj) {
          const daysUntil = Math.ceil((dateObj - today) / (1000 * 60 * 60 * 24));
          if (daysUntil === 0) dateDisplay = 'Today';
          else if (daysUntil === 1) dateDisplay = 'Tomorrow';
          else if (daysUntil < 7) dateDisplay = `In ${daysUntil} days`;
          else dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        const eventId = ev.id || ev._id || '';
        return `
          <div class="sticky-note ${type}" onclick="handleStickyNoteClick('${eventId}', '${type}')">
            <div class="sticky-note-title">${title}</div>
            <div class="sticky-note-date">üìÖ ${dateDisplay}</div>
          </div>
        `;
      }).join('');
    }
    
    function handleStickyNoteClick(eventId, type) {
      if (type === 'event') {
        openEditEventModal(eventId);
      } else {
        if (type === 'bill') {
          window.location.href = '/bills';
        } else if (type === 'chore') {
          window.location.href = '/chores';
        }
      }
    }
    
    // Event Modal Functions
    function toggleAllDay(mode) {
      const allDay = document.getElementById(`${mode}_event_all_day`).checked;
      document.getElementById(`${mode}_event_time_fields`).style.display = allDay ? 'none' : 'block';
      document.getElementById(`${mode}_event_date_fields`).style.display = allDay ? 'block' : 'none';
    }
    
    async function loadGroupMembers() {
      const groupName = getGroupName();
      if (!groupName) return [];
      
      try {
        const response = await apiGet(`/groups/${groupName}/members`);
        return response.members || [];
      } catch (err) {
        console.error('Error loading members:', err);
        return [];
      }
    }
    
    async function loadEventMembersForAdd() {
      const container = document.getElementById('add_event_members_list');
      const members = await loadGroupMembers();
      
      container.innerHTML = members.map(m => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
          <input type="checkbox" class="event-member-checkbox" data-user-id="${m.user_id}" style="margin: 0;">
          <span>${m.username || m.email}</span>
        </label>
      `).join('');
    }
    
    async function loadEventMembersForEdit(event) {
      const container = document.getElementById('edit_event_members_list');
      const members = await loadGroupMembers();
      const visibleTo = event.visible_to || [];
      
      container.innerHTML = members.map(m => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
          <input type="checkbox" class="event-member-checkbox" data-user-id="${m.user_id}" 
                 ${visibleTo.includes(m.user_id) ? 'checked' : ''} style="margin: 0;">
          <span>${m.username || m.email}</span>
        </label>
      `).join('');
    }
    
    function updateEventVisibilityCheckboxes(mode) {
      const visibility = document.getElementById(`${mode}_event_visibility`).value;
      const checkboxes = document.querySelectorAll(`#${mode}_event_members_list .event-member-checkbox`);
      const currentUserId = sessionStorage.getItem("user_id");
      
      if (visibility === 'only_me') {
        checkboxes.forEach(cb => {
          cb.checked = cb.dataset.userId === currentUserId;
        });
      } else if (visibility === 'all') {
        checkboxes.forEach(cb => {
          cb.checked = true;
        });
      }
    }
    
    function openAddEventModal(prefillDate = null) {
      document.getElementById('add_event_title').value = '';
      document.getElementById('add_event_description').value = '';
      document.getElementById('add_event_all_day').checked = false;
      
      if (prefillDate) {
        document.getElementById('add_event_start_date').value = prefillDate;
        document.getElementById('add_event_end_date').value = prefillDate;
        document.getElementById('add_event_start').value = prefillDate + 'T09:00';
        document.getElementById('add_event_end').value = prefillDate + 'T10:00';
      } else {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        document.getElementById('add_event_start').value = `${today}T${time}`;
        document.getElementById('add_event_end').value = `${today}T${String(parseInt(time.split(':')[0]) + 1).padStart(2, '0')}:${time.split(':')[1]}`;
        document.getElementById('add_event_start_date').value = today;
        document.getElementById('add_event_end_date').value = today;
      }
      
      document.getElementById('add_event_visibility').value = 'only_me';
      toggleAllDay('add');
      loadEventMembersForAdd();
      updateEventVisibilityCheckboxes('add');
      openModal('modal-add-event');
    }
    
    async function submitAddEvent() {
      const title = document.getElementById('add_event_title').value.trim();
      const description = document.getElementById('add_event_description').value.trim();
      const allDay = document.getElementById('add_event_all_day').checked;
      const visibility = document.getElementById('add_event_visibility').value;
      
      if (!title) {
        showToast("Event title is required", "error");
        return;
      }
      
      let startDatetime, endDatetime;
      if (allDay) {
        const startDate = document.getElementById('add_event_start_date').value;
        const endDate = document.getElementById('add_event_end_date').value || startDate;
        if (!startDate) {
          showToast("Please select a start date", "error");
          return;
        }
        startDatetime = startDate + 'T00:00:00';
        endDatetime = endDate + 'T23:59:59';
      } else {
        const startValue = document.getElementById('add_event_start').value;
        const endValue = document.getElementById('add_event_end').value;
        if (!startValue || !endValue) {
          showToast("Please select both start and end times", "error");
          return;
        }
        startDatetime = startValue.replace('T', ' ') + ':00';
        endDatetime = endValue.replace('T', ' ') + ':00';
      }
      
      const checkboxes = document.querySelectorAll('#add_event_members_list .event-member-checkbox:checked');
      const visibleTo = Array.from(checkboxes).map(cb => cb.dataset.userId);
      const currentUserId = sessionStorage.getItem("user_id");
      
      let finalVisibility = visibility;
      let finalVisibleTo = visibleTo;
      
      if (visibleTo.length === 1 && visibleTo[0] === currentUserId) {
        finalVisibility = 'only_me';
      } else {
        const allMembers = await loadGroupMembers();
        if (visibleTo.length === allMembers.length) {
          finalVisibility = 'all';
          finalVisibleTo = undefined;
        }
      }
      
      const groupName = getGroupName();
      if (!groupName) {
        showToast("Please select a group first", "error");
        return;
      }
      
      try {
        await apiPost(`/groups/${groupName}/events`, {
          title,
          description,
          start_datetime: startDatetime,
          end_datetime: endDatetime,
          all_day: allDay,
          visibility: finalVisibility,
          visible_to: finalVisibleTo
        });
        showToast("Event created successfully", "success");
        closeModal('modal-add-event');
        loadEvents();
      } catch (err) {
        showToast(err.message || "Failed to create event", "error");
      }
    }
    
    async function openEditEventModal(eventId) {
      editingEventId = eventId;
      try {
        const event = await apiGet(`/events/${eventId}`);
        
        document.getElementById('edit_event_title').value = event.title || '';
        document.getElementById('edit_event_description').value = event.description || '';
        document.getElementById('edit_event_all_day').checked = event.all_day || false;
        
        const startDate = (event.start_datetime || event.start || '').split('T')[0] || (event.start_datetime || event.start || '').split(' ')[0];
        const endDate = (event.end_datetime || event.end || '').split('T')[0] || (event.end_datetime || event.end || '').split(' ')[0];
        
        if (event.all_day) {
          document.getElementById('edit_event_start_date').value = startDate;
          document.getElementById('edit_event_end_date').value = endDate;
        } else {
          const startDateTime = (event.start_datetime || event.start || '').replace(' ', 'T').substring(0, 16);
          const endDateTime = (event.end_datetime || event.end || '').replace(' ', 'T').substring(0, 16);
          document.getElementById('edit_event_start').value = startDateTime;
          document.getElementById('edit_event_end').value = endDateTime;
        }
        
        document.getElementById('edit_event_visibility').value = event.visibility || 'all';
        toggleAllDay('edit');
        await loadEventMembersForEdit(event);
        updateEventVisibilityCheckboxes('edit');
        openModal('modal-edit-event');
      } catch (err) {
        showToast(err.message || "Failed to load event", "error");
      }
    }
    
    async function submitEditEvent() {
      const title = document.getElementById('edit_event_title').value.trim();
      const description = document.getElementById('edit_event_description').value.trim();
      const allDay = document.getElementById('edit_event_all_day').checked;
      const visibility = document.getElementById('edit_event_visibility').value;
      
      if (!title) {
        showToast("Event title is required", "error");
        return;
      }
      
      let startDatetime, endDatetime;
      if (allDay) {
        const startDate = document.getElementById('edit_event_start_date').value;
        const endDate = document.getElementById('edit_event_end_date').value || startDate;
        startDatetime = startDate + 'T00:00:00';
        endDatetime = endDate + 'T23:59:59';
      } else {
        const startValue = document.getElementById('edit_event_start').value;
        const endValue = document.getElementById('edit_event_end').value;
        startDatetime = startValue.replace('T', ' ') + ':00';
        endDatetime = endValue.replace('T', ' ') + ':00';
      }
      
      const checkboxes = document.querySelectorAll('#edit_event_members_list .event-member-checkbox:checked');
      const visibleTo = Array.from(checkboxes).map(cb => cb.dataset.userId);
      const currentUserId = sessionStorage.getItem("user_id");
      
      let finalVisibility = visibility;
      let finalVisibleTo = visibleTo;
      
      if (visibleTo.length === 1 && visibleTo[0] === currentUserId) {
        finalVisibility = 'only_me';
      } else {
        const allMembers = await loadGroupMembers();
        if (visibleTo.length === allMembers.length) {
          finalVisibility = 'all';
          finalVisibleTo = undefined;
        }
      }
      
      try {
        await apiPatch(`/events/${editingEventId}`, {
          title,
          description,
          start_datetime: startDatetime,
          end_datetime: endDatetime,
          all_day: allDay,
          visibility: finalVisibility,
          visible_to: finalVisibleTo
        });
        showToast("Event updated successfully", "success");
        closeModal('modal-edit-event');
        loadEvents();
      } catch (err) {
        showToast(err.message || "Failed to update event", "error");
      }
    }
    
    async function confirmDeleteEvent() {
      if (!editingEventId) return;
      
      const confirmed = confirm("Are you sure you want to delete this event? This action cannot be undone.");
      if (!confirmed) return;
      
      try {
        await apiDelete(`/events/${editingEventId}`);
        showToast("Event deleted successfully", "success");
        closeModal('modal-edit-event');
        loadEvents();
      } catch (err) {
        showToast(err.message || "Failed to delete event", "error");
      }
    }
    
    // Initialize calendar when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        renderCalendar();
        loadEvents();
      });
    } else {
      renderCalendar();
      loadEvents();
    }
  </script>
{% endblock %}
